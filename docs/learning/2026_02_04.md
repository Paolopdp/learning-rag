# 2026-02-04 — Observability: OpenTelemetry + Jaeger

## What we added
We introduced OpenTelemetry (OTel) instrumentation in the backend and added a local Jaeger collector via Docker Compose.

### Components
- **OpenTelemetry (OTel):** A vendor‑neutral standard for capturing telemetry (traces, metrics, logs). We currently use it for **tracing**.
- **Jaeger (collector + UI):** A local backend that receives OTLP traces and provides a UI to visualize them.

## Why we introduced this
1. **Portfolio signal:** Shows production‑grade engineering practices (observability and traceability).
2. **Debugging:** Lets us see the full request path (ingest → retrieval → answer) and find latency bottlenecks.
3. **Governance:** Auditable behavior is easier to show when every request has a trace.

## How it works (in this project)
1. The backend starts with OTel enabled via `RAG_OTEL_ENABLED=1`.
2. The app initializes a tracer provider and instruments FastAPI.
3. Each API request produces a trace span.
4. Spans are exported either to:
   - **Console** (default for quick local dev), or
   - **OTLP endpoint** (Jaeger) when `OTEL_EXPORTER_OTLP_ENDPOINT` is set.
5. Jaeger collects spans and exposes them in the UI.

## How to use it locally
### 1) Start Jaeger
```bash
docker compose --profile observability up -d jaeger
```
UI: `http://localhost:16686`

### 2) Run backend with OTel enabled
```bash
cd backend
uv pip install -e ".[dev,observability]"
export RAG_OTEL_ENABLED=1
export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318/v1/traces
export OTEL_SERVICE_NAME=rag-backend
uvicorn app.main:app --reload
```

### 3) Generate traffic
Use the UI or curl:
```bash
curl -X POST http://127.0.0.1:8000/workspaces/<ID>/query \
  -H "Authorization: Bearer <TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"question": "Che cos’è SPID?", "top_k": 3}'
```

### 4) View traces
Open Jaeger UI → select service `rag-backend` → click **Find Traces**.

## Advantages
- **Root cause analysis:** traces show which step is slow.
- **Audit trail visibility:** easy to demonstrate what happened for a request.
- **Vendor neutral:** OTel lets us swap backends later without rewriting code.
- **Scales with complexity:** useful now, essential later.

## Notes / tradeoffs
- **Overhead:** tracing adds some latency, but minimal for local dev.
- **Optional:** can be disabled by default for simplicity.
- **Security:** in production, OTLP endpoints should be protected.
- **Audit index:** when audit volume grows, a composite index `(workspace_id, created_at)` speeds up the audit list query. Added in migration `0004`.

## TL;DR
- OTel instruments the API.
- Jaeger collects and shows traces.
- It helps debugging, governance, and portfolio credibility.
